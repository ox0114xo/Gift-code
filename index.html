<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è´éº»äº†ç¦®åŒ…ç¢¼</title>
    
    <link rel="icon" href="https://raw.githubusercontent.com/ox0114xo/Gift-code/b9cefb2c764b9b84b111abfddf9df6ec9327a6f5/1771553807683.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/ox0114xo/Gift-code/b9cefb2c764b9b84b111abfddf9df6ec9327a6f5/1771553807683.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="è´éº»äº†ç¦®åŒ…ç¢¼">
    <meta name="theme-color" content="#f2f4f7">
    <link rel="manifest" id="pwa-manifest">

    <style>
        /* æ¥µç°¡åŒ– CSS */
        body,html { margin:0; padding:0; font-family:-apple-system,BlinkMacSystemFont,sans-serif; background:#f2f4f7; color:#333; user-select:none; }
        * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        .wrap { max-width:600px; margin:0 auto; padding:15px; min-height:100vh; }
        h2 { text-align:center; color:#2c3e50; margin:5px 0 20px; font-size:1.8rem; font-weight:900; }
        
        .dash { display:flex; background:#fff; padding:15px; border-radius:16px; margin-bottom:15px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,.05); }
        .dash div { flex:1; }
        .dash span { font-size:.85rem; color:#95a5a6; font-weight:700; }
        .dash strong { display:block; font-size:1.5rem; color:#2c3e50; font-weight:900; }
        
        .ctrl { display:flex; gap:8px; margin-bottom:15px; position:sticky; top:10px; z-index:10; background:rgba(242,244,247,.95); padding:5px 0; backdrop-filter:blur(5px); }
        .ctrl button { flex:1; padding:12px 0; border:none; border-radius:50px; background:#fff; font-weight:bold; color:#555; box-shadow:0 2px 8px rgba(0,0,0,.08); cursor:pointer; }
        .ctrl button.on { background:#2c3e50; color:#fff; }
        
        .card { background:#fff; padding:18px; border-radius:16px; margin-bottom:12px; position:relative; border:1px solid #f0f0f0; }
        .card.r { opacity:.6; background:#f8f9fa; }
        .card.p { background:#fffcf2; }
        .card.b { opacity:.7; background:#fff5f5; }
        .c-top { display:flex; justify-content:space-between; margin-bottom:12px; align-items:center; }
        .c-top strong { color:#e74c3c; font-size:1.3rem; font-weight:800; }
        .c-top span { background:#eee; padding:3px 8px; border-radius:6px; font-size:.8rem; margin-left:8px; font-weight:bold; color:#555; }
        .note { color:#888; font-size:.9rem; max-width:60%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:right;}
        .code { background:#ebf5ff; color:#007bff; border:2px dashed #a6cfff; padding:14px; text-align:center; border-radius:10px; font-family:monospace; font-size:1.4rem; font-weight:bold; margin-bottom:12px; cursor:pointer; user-select:all; }
        .acts { display:flex; justify-content:space-between; border-top:1px solid #eee; padding-top:12px; align-items:center; }
        .acts a { color:#999; font-size:.85rem; padding:6px 10px; background:#f9f9f9; border-radius:8px; cursor:pointer; }
        label { display:flex; align-items:center; gap:8px; font-weight:bold; color:#555; cursor:pointer; }
        input[type="checkbox"] { width:22px; height:22px; accent-color:#27ae60; cursor:pointer; }
        
        .btn { width:100%; padding:14px; border:none; border-radius:12px; font-weight:bold; font-size:1.05rem; cursor:pointer; margin-bottom:15px; }
        
        #toast { position:fixed; bottom:-50px; left:50%; transform:translateX(-50%); background:rgba(30,30,30,.9); color:#fff; padding:12px 24px; border-radius:50px; transition:.3s; z-index:99; font-weight:bold; white-space:nowrap; }
        
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); align-items:center; justify-content:center; z-index:100; backdrop-filter:blur(2px); }
        .m-box { background:#fff; padding:25px; border-radius:20px; width:85%; max-width:320px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,.25); }

        /* === æ¼‚æµ®å®‰è£é€šçŸ¥æ¢ === */
        .install-bar { display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%); width:92%; max-width:450px; background:#2c3e50; color:#fff; padding:14px 18px; border-radius:16px; box-shadow:0 10px 25px rgba(0,0,0,0.3); z-index:9999; align-items:center; gap:12px; animation: slideUp 0.5s ease; }
        .i-logo { width:45px; height:45px; border-radius:10px; object-fit:cover; }
        .i-text { flex:1; display:flex; flex-direction:column; }
        .i-text strong { font-size:1.05rem; }
        .i-text span { font-size:0.8rem; color:#bdc3c7; margin-top:2px; }
        .i-btn { background:#27ae60; color:#fff; border:none; padding:8px 16px; border-radius:50px; font-weight:bold; cursor:pointer; font-size:0.95rem; }
        .i-btn:active { transform:scale(0.95); }
        .i-close { padding:5px; color:#7f8c8d; cursor:pointer; font-size:1.2rem; margin-left:5px; font-weight:bold; }
        @keyframes slideUp { from { bottom:-100px; opacity:0; } to { bottom:20px; opacity:1; } }
    </style>
</head>
<body>
    <div class="wrap">
        <h2>è´éº»äº†ç¦®åŒ…ç¢¼</h2>
        
        <div class="dash">
            <div><span>ç¦®åŒ…ç¸½æ•¸</span><strong id="v-cnt">0</strong></div>
            <div><span>ç¸½ç¦åˆ©</span><strong id="v-pts" style="color:#e74c3c">0</strong></div>
        </div>

        <div class="ctrl">
            <button id="b-date" class="on" onclick="app.sort('d')">ğŸ“… æ—¥æœŸ</button>
            <button id="b-pts" onclick="app.sort('p')">ğŸ’° é»æ•¸</button>
            <button id="b-fil" onclick="app.filt()">ğŸ“‹ æœªé ˜</button>
        </div>

        <div id="loading" style="text-align:center;color:#e67e22;font-weight:bold;padding:20px;">ğŸ”„ é€£ç·šè®€å–ä¸­...</div>
        
        <div style="font-weight:bold;color:#555;margin:15px 0 10px;padding-left:10px;border-left:4px solid #e74c3c;">ğŸ”¥ æœ€æ–°ç¦®åŒ…å€</div>
        <div id="list"></div>

        <button class="btn" style="background:#e0e0e0;color:#555;box-shadow:none;margin-top:15px;" onclick="document.getElementById('old').style.display='block';this.style.display='none';">ğŸ“‚ é¡¯ç¤ºæ­·å²åº«å­˜ â–¼</button>
        <div id="old" style="display:none"></div>

        <div style="text-align:center; margin-top:40px;"><span style="font-size:0.9rem; color:#ccc; cursor:pointer; text-decoration:underline;" onclick="app.reset()">é‡ç½®ç´€éŒ„</span></div>
    </div>

    <div id="toast"></div>

    <div id="mod" class="modal">
        <div class="m-box">
            <h3 style="margin-top:0;margin-bottom:20px;color:#333;">å›å ±å¤±æ•ˆ</h3>
            <button class="btn" style="background:#fff5f5;color:#e74c3c;border:1px solid #ffcccc;box-shadow:none;" onclick="app.rep('éæœŸ')">ğŸ“… å·²éæœŸ</button>
            <button class="btn" style="background:#fff5f5;color:#e74c3c;border:1px solid #ffcccc;box-shadow:none;" onclick="app.rep('é ˜å®Œ')">ğŸ˜« å·²é ˜å®Œ</button>
            <button class="btn" style="background:#fff;color:#555;border:1px solid #eee;box-shadow:none;margin-bottom:0;" onclick="document.getElementById('mod').style.display='none'">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="install-bar" class="install-bar">
        <img src="https://raw.githubusercontent.com/ox0114xo/Gift-code/b9cefb2c764b9b84b111abfddf9df6ec9327a6f5/1771553807683.png" class="i-logo">
        <div class="i-text">
            <strong>åŠ åˆ°æ‰‹æ©Ÿæ¡Œé¢</strong>
            <span id="i-desc">ä¸€éµé–‹å•Ÿï¼Œå…æ‰¾ç¶²å€ï¼</span>
        </div>
        <button id="i-btn" class="i-btn">å®‰è£</button>
        <span class="i-close" onclick="document.getElementById('install-bar').style.display='none'">âœ•</span>
    </div>

    <script>
    // === è¨­å®šå€ ===
    const SHEET = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSkENoeJW2fV8JucN514cMysAStsgNLzjbYKrE04bDSAJOKTayexd-Ve3Fce4KB6FQsXvtMTgPZ7Mnw/pub?output=csv";
    const CUT = 213; // æ–°èˆŠç¦®åŒ…åˆ†ç•Œç·š

    // === å‹•æ…‹å¯«å…¥ PWA æ¢ä»¶ (è§¸ç™¼å®‰å“ä¸€éµå®‰è£) ===
    const icon = "https://raw.githubusercontent.com/ox0114xo/Gift-code/b9cefb2c764b9b84b111abfddf9df6ec9327a6f5/1771553807683.png";
    document.getElementById('pwa-manifest').href = 'data:application/manifest+json;utf-8,'+encodeURIComponent(JSON.stringify({name:"è´éº»äº†ç¦®åŒ…ç¢¼",short_name:"è´éº»äº†",start_url:".",display:"standalone",background_color:"#f2f4f7",icons:[{src:icon,sizes:"192x192",type:"image/png"}]}));
    if('serviceWorker' in navigator) navigator.serviceWorker.register(URL.createObjectURL(new Blob(["self.addEventListener('fetch',e=>{});"], {type:'text/javascript'})));

    // === å®‰è£é€šçŸ¥é‚è¼¯ ===
    let defPrompt;
    const isApp = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
    const iBar = document.getElementById('install-bar');
    const iBtn = document.getElementById('i-btn');
    const iDesc = document.getElementById('i-desc');

    if (!isApp) {
        // å®‰å“ç³»çµ±ï¼šæ“·å–ç³»çµ±å®‰è£äº‹ä»¶
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            defPrompt = e;
            iBar.style.display = 'flex'; // é¡¯ç¤ºé€šçŸ¥
            
            iBtn.onclick = () => {
                defPrompt.prompt();
                defPrompt.userChoice.then((choice) => {
                    if (choice.outcome === 'accepted') iBar.style.display = 'none';
                    defPrompt = null;
                });
            };
        });

        // è˜‹æœç³»çµ±ï¼šå»¶é²è·³å‡ºæ–‡å­—å¼•å°
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS) {
            setTimeout(() => {
                iBar.style.display = 'flex';
                iDesc.innerHTML = "é»æ“Šåº•éƒ¨çš„ <b>åˆ†äº«â—</b> åŠ åˆ°ä¸»ç•«é¢";
                iBtn.style.display = 'none'; // iOS éš±è—å®‰è£æŒ‰éˆ•
            }, 800);
        }
    }

    // === æ ¸å¿ƒç¨‹å¼ ===
    const app = {
        d: [], st: JSON.parse(localStorage.getItem('gData')) || { r:[], p:[], b:{}, s:'d', asc:false, f:false }, tId: null,
        init() {
            fetch(SHEET).then(r=>r.text()).then(c=>{
                document.getElementById('loading').style.display='none';
                let l = c.split(/\r?\n/);
                for(let i=1; i<l.length; i++){
                    let row = l[i].split(',');
                    if(row[2]) this.d.push({ d:row[0].trim(), p:+row[1], c:row[2].trim(), n:row[3]||"" });
                }
                this.rnd();
            }).catch(()=>document.getElementById('loading').innerText='âš ï¸ è³‡æ–™è®€å–å¤±æ•—');
        },
        sv() { localStorage.setItem('gData', JSON.stringify(this.st)); this.rnd(); },
        pd(d) { let a=d.split('/'); return a[0]*100 + +a[1]; },
        rnd() {
            let pts=0, a=this.d.filter(x=>{ pts+=x.p; return !this.st.f || (!this.st.r.includes(x.c) && !this.st.b[x.c]); });
            document.getElementById('v-cnt').innerText = this.d.length;
            document.getElementById('v-pts').innerText = pts;
            a.sort((x,y) => this.st.s==='d' ? (this.st.asc ? this.pd(x.d)-this.pd(y.d) : this.pd(y.d)-this.pd(x.d)) : (this.st.asc ? x.p-y.p : y.p-x.p));
            
            let hN='', hO='';
            a.forEach(x => {
                let isR=this.st.r.includes(x.c), isP=this.st.p.includes(x.c), isB=!!this.st.b[x.c];
                let cls = isB?'b':isR?'r':isP?'p':'';
                let tag = isB?'<div class="tag b" style="position:absolute;top:0;right:0;padding:4px 10px;font-size:0.75rem;border-radius:0 16px 0 12px;background:#ffcccc;color:#c0392b;font-weight:bold;">âš ï¸ å¤±æ•ˆ</div>' : 
                          isP?'<div class="tag p" style="position:absolute;top:0;right:0;padding:4px 10px;font-size:0.75rem;border-radius:0 16px 0 12px;background:#ffeeba;color:#b7791f;font-weight:bold;">â³ æš«å­˜</div>' : '';
                
                let h = `<div class="card ${cls}">${tag}<div class="c-top"><div><strong>ğŸ’°${x.p}</strong><span>${x.d}</span></div><div class="note">${x.n}</div></div><div class="code" onclick="app.cp('${x.c}')">${x.c}</div><div class="acts"><div style="display:flex;gap:8px"><a onclick="app.op('${x.c}')">âš ï¸å›å ±</a><a onclick="app.tp('${x.c}')" style="color:${isP?'#d35400':'#999'}">â³è³‡æ ¼æœªç¬¦</a></div><label><input type="checkbox" onchange="app.tr('${x.c}',this.checked)" ${isR?'checked':''}>å·²é ˜</label></div></div>`;
                this.pd(x.d)>=CUT ? hN+=h : hO+=h;
            });
            document.getElementById('list').innerHTML = hN||'<div style="text-align:center;padding:20px;color:#999">ç„¡è³‡æ–™</div>';
            document.getElementById('old').innerHTML = hO||'<div style="text-align:center;padding:20px;color:#999">ç„¡è³‡æ–™</div>';
            
            document.getElementById('b-date').className=this.st.s==='d'?'on':'';
            document.getElementById('b-pts').className=this.st.s==='p'?'on':'';
            document.getElementById('b-fil').className=this.st.f?'on':'';
        },
        sort(k) { this.st.asc = (this.st.s===k) ? !this.st.asc : false; this.st.s=k; this.sv(); },
        filt() { this.st.f = !this.st.f; this.sv(); },
        tr(c, v) { v ? (this.st.r.push(c), this.st.p=this.st.p.filter(x=>x!==c)) : this.st.r=this.st.r.filter(x=>x!==c); this.sv(); },
        tp(c) { this.st.p.includes(c) ? this.st.p=this.st.p.filter(x=>x!==c) : this.st.p.push(c); this.sv(); },
        cp(c) { 
            if(this.st.b[c]) return this.msg('âš ï¸ è©²åºè™Ÿå·²å›å ±å¤±æ•ˆ'); 
            let e=document.createElement('textarea'); e.value=c; document.body.appendChild(e); e.select(); document.execCommand('copy'); e.remove();
            this.msg('âœ… å·²è¤‡è£½ä¸¦æ¨™è¨˜é ˜å–'); this.tr(c,true); 
        },
        msg(m) { let t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); t.style.bottom='40px'; setTimeout(()=>{t.style.bottom='-50px'; t.classList.remove('show');},2000); },
        op(c) { this.tId=c; document.getElementById('mod').style.display='flex'; },
        rep(t) { this.st.b[this.tId]=t; this.sv(); document.getElementById('mod').style.display='none'; this.cp('å›å ±ï¼šåºè™Ÿ '+this.tId+' å·²'+t); },
        reset() { if(confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰ç´€éŒ„ï¼Ÿ')){ localStorage.removeItem('gData'); location.reload(); } }
    };
    app.init();
    </script>
</body>
</html>
